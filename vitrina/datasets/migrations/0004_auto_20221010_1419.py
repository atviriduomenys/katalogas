# Generated by Django 3.2.16 on 2022-10-10 11:19

from django.db import migrations


def create_history_objects(apps, schema_editor):
    DatasetEvent = apps.get_model('vitrina_datasets', 'DatasetEvent')
    Dataset = apps.get_model('vitrina_datasets', 'Dataset')
    Revision = apps.get_model('reversion', 'Revision')
    Version = apps.get_model('reversion', 'Version')
    ContentType = apps.get_model('contenttypes', 'ContentType')

    for event in DatasetEvent.objects.exclude(dataset_id__isnull=True)[:10]:
        content_type = ContentType.objects.get_for_model(Dataset)
        dataset = Dataset.objects.get(pk=event.dataset_id)
        revision = Revision.objects.create(
            date_created=event.created,
            user=event.user_0,
            comment=event.type or "",
        )
        Version.objects.create(
            object_id=event.dataset_id,
            content_type=content_type,
            object_repr=str(dataset),
            format="json",
            db="default",
            revision=revision
        )


class Migration(migrations.Migration):

    dependencies = [
        ('vitrina_datasets', '0003_auto_20220905_0914'),
    ]

    operations = [
        migrations.RunPython(create_history_objects)
    ]
