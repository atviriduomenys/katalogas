# Generated by Django 3.2.16 on 2022-10-21 07:00
from pathlib import Path

from django.db import migrations, models


def fix_dataset_structure_files(apps, schema_editor):
    DatasetStructure = apps.get_model('vitrina_datasets', 'DatasetStructure')

    for structure in DatasetStructure.objects.all():
        if structure.filename:
            # TODO: change to path that was used in the old project
            old_path = f"var/media/files/{structure.filename}"
            new_path = f'var/media/datasets/{structure.dataset.organization.kind}/' \
                       f'{structure.dataset.organization.slug}/'
            if Path(old_path).exists():
                if not Path(new_path).exists():
                    Path(new_path).mkdir(parents=True)
                Path(old_path).rename(f"{new_path}/{structure.filename}")
                structure.file = f"datasets/{structure.dataset.organization.kind}/" \
                                 f"{structure.dataset.organization.slug}/{structure.filename}"
                structure.save(update_fields=['file'])


class Migration(migrations.Migration):

    dependencies = [
        ('vitrina_datasets', '0007_merge_0005_auto_20221010_1054_0006_remake_tags'),
    ]

    operations = [
        migrations.AlterField(
            model_name='datasetstructure',
            name='file',
            field=models.FileField(blank=True, max_length=512, null=True,
                                   upload_to='manifest/%Y/%m-%d'),
        ),
        migrations.RunPython(fix_dataset_structure_files)
    ]
