{% extends "base.html" %}
{% load i18n %}
{% load static %}
{% load hitcount_tags %}

{% block pageTitle %} | {{ dataset.title }}{% endblock %}
{% block pageDescription %}{{ dataset.description | escape }}{% endblock %}
{% block pageAuthor %}{{ organization.title }}{% endblock %}
{% block pageOgTitle %} | {{ dataset.title }}{% endblock %}
{% block pageOgDescription %}{{ dataset.description | escape }}{% endblock %}

{% block parent_title %}{% translate "Duomenų rinkiniai" %}{% endblock %}
{% block current_title %}{{ dataset.title }}{% endblock %}

{% block head %}
    <link href="{% static '/css/datatables.min.css' %}" rel="stylesheet">
    <script src="{% static '/js/jquery-3.4.1.min.js' %}"></script>
    <script src="{% static '/js/datatables.min.js' %}"></script>
    <script src="{% static 'hitcount/jquery.postcsrf.js' %}"></script>
{% endblock %}

{% block content %}
    <div class="columns no-margin-bottom">
        <div class="column">
            {# description and view count #}
            <div class="columns no-margin-bottom">
                <div class="column">
                    <h3 class="custom-title is-size-4-mobile no-margin-bottom">{{ dataset.title }}</h3>
                    {% if can_update_dataset %}
                        <a href="{%url 'dataset-change' pk=dataset.id %}" class="button is-primary is-normal m-t-md is-size-6-mobile" id="change_dataset">
                            {% translate "Redaguoti rinkinį" %}
                        </a>
                    {% endif %}
                </div>
                <div class="column">
                    {% get_hit_count for dataset as total_hits %}
                    <p class="is-pulled-right">{% translate "Duomenų rinkinio peržiūros" %}:
                        <b id="total_hits">{{ total_hits }}</b>
                    </p>
                </div>
            </div>

            <div class="content">
                <p class="no-margin-bottom">{{ dataset.description | linebreaks }}</p>
                {# tags #}
                {% include "./tags.html" %}
                {# main info #}
                {% include "./coretable.html" %}
            </div>

            {% if structure or new_structure %}
                <div class="content structure-block no-margin-bottom">
                    <h4 class="custom-title is-size-4-mobile is-inline-block">{% translate "Rinkinio struktūra" %}</h4>
                    <span class="icon info-icon has-tooltip-multiline m-r-md" data-tooltip="{% translate 'Informacija apie duomenų rinkinio duomenis' %}">
                        <i class="fas fa-info-circle"></i>
                    </span>
                    {% include './structuretable.html' %}
                </div>
            {% endif %}
        </div>
        <div class="column is-one-third">
            <div class="dataset-organization">
                <div class="is-hidden-mobile">
                    {% if org_logo %}
                        <img src="/image/{{ org_logo }}" class="image max-128x128 m-b-md">
                    {% endif %}
                </div>

                <p class="dataset-meta-title">{% translate "Organizacija" %}</p>
                <p class="dataset-meta-value organization-title"><a
                            href="{{ dataset.organization.get_absolute_url }}">{{ dataset.organization.title }}</a></p>

                <p class="dataset-meta-title">{% translate "El. paštas" %}</p>
                <p class="dataset-meta-value"><a href="mailto:{{ dataset.organization.email }}">{{ dataset.organization.email|default_if_none:"" }}</a></p>

                <p class="dataset-meta-title">{% translate "Telefonas" %}</p>
                <p class="dataset-meta-value">{{ dataset.organization.phone|default_if_none:"" }}</p>

                <p class="dataset-meta-title">{% translate "Tinklalapis" %}</p>
                <p class="dataset-meta-value"><a href="{{ organization.website }}"
                                                 target="_blank">{{ dataset.organization.website|default_if_none:"" }}</a></p>

                {% if dataset.coordinator %}
                    <p class="dataset-meta-title">{% translate "Koordinatorius" %}</p>
                    <p class="dataset-meta-value"><span>{{ dataset.coordinator }}</span></p>
                    <p class="dataset-meta-value"><a href="mailto:{{ dataset.coordinator.email }}">{{ dataset.coordinator.email|default_if_none:"" }}</a>
                    </p>
                    {% if dataset.coordinator.phone %}
                        <p class="dataset-meta-value"><span>{{ dataset.coordinator.phone }}</span></p>
                    {% endif %}
                {% endif %}

                <hr class="custom-line-margin">
                <p class="dataset-meta-title m-b-md">{% translate "Dalintis socialiniuose tinkluose" %}</p>
                <p class="social-icons m-t-md">
                    <a target="_blank"
                       href="https://www.facebook.com/sharer/sharer.php?u={{ current_domain_full }}{{ dataset.get_absolute_url }}"
                       class="dataset-meta-link">
                        <span class="icon is-gray">
                            <i class="fab fa-facebook-square fa-2x"></i>
                        </span>
                    </a>
                    <a target="_blank"
                       href="https://www.linkedin.com/sharing/share-offsite/?title={{ dataset.title }}&url={{ current_domain_full }}{{ dataset.get_absolute_url }}"
                       class="dataset-meta-link m-l-sm">
                        <span class="icon is-gray">
                            <i class="fab fa-linkedin fa-2x"></i>
                        </span>
                    </a>
                    <a target="_blank"
                       href="http://twitter.com/share?text={{ dataset.title }}&url={{ current_domain_full }}{{ dataset.get_absolute_url }}"
                       class="dataset-meta-link m-l-sm">
                        <span class="icon is-gray">
                            <i class="fab fa-twitter-square fa-2x"></i>
                        </span>
                    </a>
                </p>
            </div>
        </div>
    </div>
{% endblock %}
{% block scripts %}
    {% get_hit_count_js_variables for dataset as hitcount %}
    <script type="text/javascript">
        $(document).ready(function () {
            $.postCSRF("{{ hitcount.ajax_url }}", { hitcountPK : "{{ hitcount.pk }}" });

            $(function () {
                var metaButton = $('.dataset-extra-meta-button');
                $('.reply-button').click(function () {
                    $('#media-' + this.id).toggleClass('is-hidden');
                });
                metaButton.click(function () {
                    $(this).text($(this).text() === "{% translate "Peržiūrėti papildomą informaciją" %} +" ? "{% translate "Uždaryti papildomą informaciją" %} -" : "{% translate "Peržiūrėti papildomą informaciją" %} +");
                    $('#extra-table').toggleClass('is-hidden');
                });
                $('.preview-button').click(function () {
                    $('.modal').toggleClass('is-active');
                    $('html').toggleClass('is-clipped');
                    $.getJSON('/dataset/{{ dataset.id }}/preview/' + $(this).attr('id'), function (json_data) {
                        var table_obj = document.getElementById('info-table-body');
                        $("#info-table-body").empty();
                        $.each(json_data, function (index, item) {
                            var newRow = table_obj.insertRow(index);
                            if (index === 0) {
                                newRow.classList.add("preview-tr", "is-bold");
                            } else {
                                newRow.className = "preview-tr";
                            }
                            $.each(item, function (i, j) {
                                var newCell = newRow.insertCell(i);
                                newCell.innerHTML = j;
                                newCell.className = "preview-td";
                            });
                        });
                    });
                });

                $('.new-preview-button').click(function () {
                    $('.modal').toggleClass('is-active');
                    $('html').toggleClass('is-clipped');
                    $.getJSON('/dataset/{{ dataset.id }}/previewStructure', function (json_data) {
                        var table_obj = document.getElementById('info-table-body');
                        $("#info-table-body").empty();
                        $.each(json_data, function (index, item) {
                            var newRow = table_obj.insertRow(index);
                            if (index === 0) {
                                newRow.classList.add("preview-tr", "is-bold");
                            } else {
                                newRow.className = "preview-tr";
                            }
                            $.each(item, function (i, j) {
                                var newCell = newRow.insertCell(i);
                                newCell.innerHTML = j;
                                newCell.className = "preview-td";
                            });
                        });
                    });
                });

                $('.modal-button-close').click(function () {
                    $('.modal').toggleClass('is-active');
                    $('html').toggleClass('is-clipped');
                });

                $('#reply-form').submit(function () {
                    $(this).find(":submit").attr('disabled', 'disabled');
                });

                $('#comment-form').submit(function () {
                    $(this).find(":submit").attr('disabled', 'disabled');
                });
            });
        });
    </script>
{% endblock %}
