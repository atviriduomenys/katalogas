{% extends "base.html" %}
{% load i18n %}
{% load util_tags %}

{% block head %}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css" integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ==" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js" integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw==" crossorigin=""></script>
{% endblock %}

{% block current_title %}
    {% if model.title %}
        {{ model.title }}
    {% else %}
        {{ model.name }}
    {% endif %}
{% endblock %}
{% block parent_links %}
    <ul class="p-t-sm">
        <li><a href="{% url 'home' %}"><span>{% translate 'Pradžia' %}</span></a></li>
        <li><a href="{% url 'dataset-list' %}"><span>{% translate 'Duomenų rinkiniai' %}</span></a></li>
        <li><a href="{% url 'dataset-detail' dataset.pk %}"><span>{{ dataset.title }}</span></a></li>
    </ul>
{% endblock %}

{% block content %}

{% include 'vitrina/datasets/tabs.html' %}

<div class="columns no-margin-bottom">
    <div class="column is-one-quarter">
        {% include 'vitrina/structure/side_menu.html' %}
    </div>

    <div id="object-data-table" class="column is-three-quarters">
        <div class="columns no-margin-bottom">
            <div class="column is-4"></div>
            <div class="column is-3 mt-6"><progress class="progress is-small is-primary" max="100"></progress></div>
            <div class="column is-5"></div>
        </div>
    </div>
</div>
{% endblock %}



{% block scripts %}
    <script type="text/javascript">
        $(function () {
            let datasetId = {{ dataset.pk }};
            let model = "{{model.name}}";
            let modelFullName = "{{model.full_name}}";
            modelFullName = modelFullName.replaceAll('/', '-')
            let uuid = "{{ object_id }}";

            $.ajax({
                url: `/datasets/${datasetId}/data/${modelFullName}/${uuid}/table-data/`,
            }).then(response => {
                $.ajax({
                    url: `/datasets/${datasetId}/data/${model}/${uuid}/table/`,
                    type: "POST",
                    data: {
                        'csrfmiddlewaretoken': '{{csrf_token }}',
                        'data': JSON.stringify(response),
                    }
                }).then(response => {
                    $('#object-data-table')[0].innerHTML = response['rendered_template'];

                    $('div[id^="map_"]').each( function () {
                        let id = $(this)[0].id;
                        let map = L.map(id);
                        L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

                        let layerGroup = L.layerGroup().addTo(map);

                        let geometry = $(this)[0].dataset.geometry;
                        let wkt = new Wkt.Wkt();
                        wkt.read(geometry);

                        let feature = { "type": "Feature", 'properties': {}, "geometry": wkt.toJson() };
                        let geoObj = L.geoJSON(feature, {
                            coordsToLatLng: function (coords) {
                                return new L.LatLng(coords[0], coords[1], coords[2]);
                            }
                        }).addTo(layerGroup);

                        map.fitBounds(geoObj.getBounds());
                    });
                });
            });
        });
    </script>
{% endblock %}
